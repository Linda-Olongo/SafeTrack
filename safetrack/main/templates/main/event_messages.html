{% extends 'main/event_detail_base.html' %}
{% load i18n %}

{% block title %}| Event {{ event.id }}{% endblock %}

{% block messages_active %}active{% endblock %}

{% block page_title %}Event Detail{% endblock %}

{% block page_content %}
<section>
    <div id="errorMessages"></div>
    <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <div class="container-fluid pt-30">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'events' %}">{% trans "Evenements" %}</a></li>
                <li class="breadcrumb-item"><a href="{% url 'event-detail' event.id %}">{{ event.nom }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{% trans "Messages" %}</li>
            </ol>
        </nav>

        <div class="tables-wrapper mt-6">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card-style mb-30">
                        <div
                            style="display: flex; flex-direction: row; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 class="mb-10">Messages</h3>
                            </div>
                            <div class="title d-flex flex-wrap justify-content-end">
                                <button type="button" class="main-btn primary-btn btn-hover btn-sm"
                                    data-bs-toggle="modal" data-bs-target="#eventModal">
                                    <i class="lni lni-plus mr-5"></i> Envoyer un message
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper table-responsive">
                            <table class="table" id="participants-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="select-all" class="form-check-input">
                                        </th>
                                        <th class="lead-info">
                                            <h6>{% trans "Sujet" %}</h6>
                                        </th>
                                        <!-- <th class="lead-email">
                                            <h6>{% trans "Date cree" %}</h6>
                                        </th> -->
                                        <th class="lead-phone">
                                            <h6>{% trans "Nombre de dest." %}</h6>
                                        </th>
                                        <th>
                                            <h6>{% trans "Nombre recu" %}</h6>
                                        </th>

                                        <th>
                                            <h6>{% trans "Actions" %}</h6>
                                        </th>
                                    </tr>
                                    <!-- end table row-->
                                </thead>
                                <tbody>
                                    {% for message in event.notifications.all %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="form-check-input">
                                        </td>

                                        <td>
                                            {{ message.subject }}
                                        </td>

                                        <td>
                                            {{ message.nombre_destinataires }}
                                        </td>

                                        <td>
                                            {{ message.nombre_recu }}
                                        </td>

                                        <td>
                                            <div class="action">
                                                <button class="text-primary edit-button" data-id="{{ participant.id }}"
                                                    data-bs-toggle="modal" data-bs-target="#editEventModal">
                                                    <i class="lni lni-pencil"></i>
                                                </button>
                                                <button class="text-danger delete-button" data-id="{{ participant.id }}"
                                                    data-nom="{{ evenement.nom }}" data-bs-toggle="modal"
                                                    data-bs-target="#deleteEventModal">
                                                    <i class="lni lni-trash-can"></i>
                                                </button>

                                                {% if message.nombre_destinataires > message.nombre_recu %}
                                                <button class="text-primary edit-button"
                                                    data-id="{{ participant.id }}" title="Renvoyer le message">
                                                    <i class="lni lni-reload"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <!-- end table -->
                        </div>
                    </div>
                    <!-- end card -->
                </div>
                <!-- end col -->
            </div>
        </div>
        <!-- Invoice Wrapper End -->
    </div>
    <!-- end container -->
</section>

<!-- Modal pour la création d'événement -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">{{ _('Ajouter des participants') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="newMessageForm">
                    {% csrf_token %}
                    <div class="col-md-12">
                        <label for="new-message-subject" class="form-label">Sujet du message</label>
                        <input type="text" class="form-control" name="subject" id="new-message-subject" value="Testing email...">
                    </div>
                    <div class="col-md-12">
                        <label for="new-message-content" class="form-label">Contenu</label>
                        <div class="form-check" id="">
                            <textarea name="" class="form-control" id="new-message-content" cols="30" rows="10">
                                Test text
                            </textarea>
                        </div>
                    </div>

                    <hr>

                    <table class="table" id="pick-participants-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" class="form-control form-check-input select-all">
                                </th>
                                <th class="lead-info">
                                    <h6>{% trans "Nom" %}</h6>
                                </th>
                                <th class="lead-email">
                                    <h6>{% trans "Adresse mail" %}</h6>
                                </th>
                            </tr>
                            <!-- end table row-->
                        </thead>
                        <tbody>
                            {% for participant in event.participant_set.all %}
                            <tr>
                                <td class="min-width">
                                    <input type="checkbox" class="select-one form-check-input form-control" value="{{ participant.id }}">
                                </td>
                                <td class="min-width">
                                    <div class="lead">
                                        <div class="lead-text">
                                            {{ participant.name }}
                                        </div>
                                    </div>
                                </td>
                                <td class="min-width">
                                    <p>{{ participant.email }}</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Annuler') }}</button>
                        <button type="submit" class="btn btn-primary">{{ _('Créer') }}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Modal pour la confirmation de suppression d'événement -->
<div class="modal fade" id="deleteEventModal" tabindex="-1" aria-labelledby="deleteEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteEventModalLabel">{{ _('Confirmer la suppression') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="deleteModalBody">
                {{ _('Êtes-vous sûr de vouloir supprimer ce participant ?') }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Annuler') }}</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">{{ _('Supprimer') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="participantModal" tabindex="-1" aria-labelledby="participantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter des Participants</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="participantForm">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <!-- <th>Action</th> -->
                            </tr>
                        </thead>
                        <tbody id="participantTable">
                            <!-- Rows will be dynamically added here -->
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-success" id="addRow">Ajoute une ligne</button>
                </form>

                <!-- <hr>
                <form id="uploadForm" enctype="multipart/form-data">
                    <label for="csvFile">Upload Excel File:</label>
                    <input type="file" id="csvFile" name="file" class="form-control">
                </form> -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Annuler" %}</button>
                <button type="button" class="btn btn-primary" id="submitParticipants">{% trans "Soumettre" %}</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById("newMessageForm").addEventListener('submit', (e) => {
        e.preventDefault()

        let messageSubject = document.getElementById("new-message-subject").value;
        let messageContent = document.getElementById("new-message-content").value;

        let participantIds = document.querySelectorAll('#pick-participants-table input[type="checkbox"]:checked')
        participantIds = Array.from(participantIds).map(input => parseInt(input.value))

        let data = {
            "subject": messageSubject,
            "content": messageContent,
            "participants": participantIds
        }

        displayLoader("En train d'envoyer les messages")

        fetch(`{% url 'event-messages' event.id %}`, {
            method: "POST",
            body: JSON.stringify(data),
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(response => response.json())
        .then(data => {
            displayMessage("Message cree avec succes")
            setTimeout(() =>location.reload(), 5000 ) 
        })
        .catch(() => {
            displayMessage("Erreur dans la creation du message");
        })
        .finally(() => {
            hideLoader()
        })
    })
</script>

<!-- <button type="button" class="main-btn primary-btn btn-hover btn-sm" data-bs-toggle="modal" data-bs-target="#sendEmailModal">
    <i class="lni lni-plus mr-5"></i>Open test modal
</button> -->
<!-- Bootstrap Modal -->
<div class="modal fade" id="sendEmailModal" tabindex="-1" aria-labelledby="sendEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sendEmailModalLabel">Send Email</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="emailForm">
            <div class="mb-3">
              <label for="emailSubject" class="form-label">Subject</label>
              <input type="text" class="form-control" id="emailSubject" required>
            </div>
            <div class="mb-3">
              <label for="emailMessage" class="form-label">Message</label>
              <textarea class="form-control" id="emailMessage" rows="4" required></textarea>
            </div>
            
            <!-- Selected Participants Display -->
            <div class="mb-3">
              <label class="form-label">Selected Participants</label>
              <div id="selectedParticipants" class="d-flex flex-wrap gap-2"></div>
            </div>
  
            <!-- Search Bar -->
            <div class="mb-3">
              <input type="text" id="participantSearch" class="form-control" placeholder="Search participants...">
            </div>
            
            <!-- Participants Table -->
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Select</th>
                    <th>Name</th>
                    <th>Email</th>
                  </tr>
                </thead>
                <tbody id="participantsTable">
                  <!-- Dynamically filled with JavaScript -->
                </tbody>
              </table>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" id="sendEmailBtn">Send Email</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const participants = [
        { id: 1, name: "Alice Doe", email: "alice@example.com" },
        { id: 2, name: "Bob Smith", email: "bob@example.com" },
        { id: 3, name: "Charlie Johnson", email: "charlie@example.com" }
      ];
  
      const participantsTable = document.getElementById("participantsTable");
      const selectedParticipantsDiv = document.getElementById("selectedParticipants");
      const participantSearch = document.getElementById("participantSearch");
      let selectedParticipants = [];
  
      function renderParticipantsTable(filteredParticipants = participants) {
        participantsTable.innerHTML = "";
        filteredParticipants.forEach(participant => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><input type="checkbox" data-id="${participant.id}" data-name="${participant.name}"></td>
            <td>${participant.name}</td>
            <td>${participant.email}</td>
          `;
          participantsTable.appendChild(row);
        });
      }
  
      function updateSelectedParticipants() {
        selectedParticipantsDiv.innerHTML = "";
        selectedParticipants.forEach(participant => {
          const pill = document.createElement("span");
          pill.className = "badge bg-primary p-2";
          pill.textContent = participant.name;
          selectedParticipantsDiv.appendChild(pill);
        });
      }
  
      participantsTable.addEventListener("change", function(event) {
        const checkbox = event.target;
        const participantId = checkbox.getAttribute("data-id");
        const participantName = checkbox.getAttribute("data-name");
        if (checkbox.checked) {
          selectedParticipants.push({ id: participantId, name: participantName });
        } else {
          selectedParticipants = selectedParticipants.filter(p => p.id !== participantId);
        }
        updateSelectedParticipants();
      });
  
      participantSearch.addEventListener("input", function() {
        const searchTerm = participantSearch.value.toLowerCase();
        const filteredParticipants = participants.filter(participant =>
          participant.name.toLowerCase().includes(searchTerm) ||
          participant.email.toLowerCase().includes(searchTerm)
        );
        renderParticipantsTable(filteredParticipants);
      });
  
      renderParticipantsTable();
    });
  </script>
  

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("addRow").addEventListener("click", function () {
            let table = document.getElementById("participantTable");
            let newRow = document.createElement("tr");

            newRow.innerHTML = `
            <td><input type="text" class="form-control name" required></td>
            <td><input type="email" class="form-control email" required></td>
            <td><button type="button" class="deleteRow text-danger delete-button border-0 bg-transparent"> <i class="lni lni-trash-can"></i> </button></td>
        `;

            table.appendChild(newRow);
        });

        document.getElementById("participantTable").addEventListener("click", function (event) {
            if (event.target.classList.contains("deleteRow")) {
                event.target.closest("tr").remove();
            }
        });

        document.getElementById("submitParticipants").addEventListener("click", function () {
            let participants = [];
            let rows = document.querySelectorAll("#participantTable tr");

            rows.forEach(row => {
                let name = row.querySelector(".name")?.value;
                let email = row.querySelector(".email")?.value;

                if (name && email) {
                    participants.push({ name: name, email: email });
                }
            });
            console.log("Submitting participants data: ")
            console.log(participants)

            fetch("{% url 'add_participants' event.id %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ participants: participants })
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(() => {
                    alert("Error adding participants");
                });
        });

        document.getElementById("uploadCSV").addEventListener("click", function () {
            let fileInput = document.getElementById("csvFile");
            let formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

            fetch("{% url 'add_participants' event.id %}", {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(() => {
                    alert("Error uploading file");
                });
        });
    });

</script>

{{ participants_json|json_script:"my-data" }}

<script>
    function formatDate(dateString) {
        const date = new Date(dateString);

        // Format the date
        return date.toISOString().slice(0, 19);
    }

    console.log("About to get participants")
    participants = JSON.parse(document.getElementById('my-data').textContent);
    console.log("Participants are: ")

    document.addEventListener("DOMContentLoaded", function () {
        function showToast(message, type) {
            const toastContainer = document.getElementById("toastContainer");
            const toast = document.createElement("div");
            toast.className = `toast align-items-center text-bg-${type} border-0`;
            toast.setAttribute("role", "alert");
            toast.setAttribute("aria-live", "assertive");
            toast.setAttribute("aria-atomic", "true");

            toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;

            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Gestion de l'ajout d'événement
        document.getElementById("eventForm").addEventListener("submit", function (event) {
            event.preventDefault();
            let form = document.getElementById("eventForm");
            let formData = new FormData(form);
            console.log(formData)

            for (let [key, value] of formData.entries()) {
                console.log(key, value);
            }

            fetch(`/events/`, {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast("{{ _('Événement créé avec succès!') }}", "success");
                        location.reload();  // Refresh the page or update UI dynamically
                    } else {
                        let errorDiv = document.getElementById("errorMessages");
                        errorDiv.innerHTML = ""; // Clear previous errors
                        for (const [field, errors] of Object.entries(data.errors)) {
                            errors.forEach(error => {
                                let errorElement = document.createElement("p");
                                errorElement.style.color = "red";
                                errorElement.innerText = `${field}: ${error}`;
                                errorDiv.appendChild(errorElement);
                            });
                        }
                    }
                })
                .catch(error => console.error("Error:", error));
        });

        // Gestion de la modification d'événement
        document.querySelectorAll(".edit-button").forEach(button => {
            button.addEventListener("click", function () {
                let id = this.getAttribute("data-id");
                for (let index = 0; index < participants.length; index++) {
                    const element = participants[index];
                    if (element.id == id) {
                        document.getElementById("editParticipantId").value = element.id;
                        document.getElementById('edit_name').value = element.name;
                        document.getElementById('edit_statut').value = element.statut;
                        document.getElementById('edit_email').value = element.email;
                    } else {
                        console.log(`element id ${element.id} != ${id}`)
                    }
                }
            })
        });

        document.getElementById("editEventForm").addEventListener("submit", function (event) {
            event.preventDefault();
            let form = document.getElementById("editEventForm");
            let formData = new FormData(form);
            let eventId = formData.get("id");

            fetch(`/participants/${eventId}/change/`, {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast("{{ _('Événement modifié avec succès!') }}", "success");
                        location.reload();  // Refresh the page or update UI dynamically
                    } else {
                        let errorDiv = document.getElementById("errorMessages");
                        errorDiv.innerHTML = ""; // Clear previous errors
                        for (const [field, errors] of Object.entries(data.errors)) {
                            errors.forEach(error => {
                                let errorElement = document.createElement("p");
                                errorElement.style.color = "red";
                                errorElement.innerText = `${field}: ${error}`;
                                errorDiv.appendChild(errorElement);
                            });
                        }
                    }
                })
                .catch(error => console.error("Error:", error));
        });

        // Gestion de la suppression d'événement
        document.querySelectorAll(".delete-button").forEach(button => {
            button.addEventListener("click", function () {
                let eventId = this.getAttribute("data-id");
                let eventName = this.getAttribute("data-nom");
                document.getElementById("confirmDelete").setAttribute("data-id", eventId);
                document.getElementById("deleteModalBody").innerText = `{{ _('Êtes-vous sûr de vouloir supprimer ') }} "${eventName}" {{ _(' ?')}}`;
            });
        });

        document.getElementById("confirmDelete").addEventListener("click", function () {
            let eventId = this.getAttribute("data-id");

            fetch(`/events/${eventId}/delete/`, {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast("{{ _('Événement supprimé avec succès!') }}", "success");
                        location.reload();  // Refresh the page or update UI dynamically
                    } else {
                        showToast("{{ _('Une erreur s\'est produite.') }}", "danger");
                    }
                })
                .catch(error => console.error("Error:", error));
        });
    });
</script>
{% endblock %}